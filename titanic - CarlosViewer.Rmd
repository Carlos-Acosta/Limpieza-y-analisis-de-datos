---
title: "**M2.851 – TIPOLOGÍA Y CICLO DE VIDA DE LOS DATOS: PRA 2**"
author: "Olga Garcés Ciemerozum / Carlos Acosta Quintas"
date: 'Junio 2021'
output:
  html_document:
    highlight: default
    number_sections: yes
    theme: cosmo
    toc: yes
    toc_depth: 4

     
---

<style>
body {
text-align: justify}
</style>



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.align="center")
options(width = 500)

```


```{r load_libraries, message=FALSE, warning=FALSE, include=FALSE}
# Cargamos las librerias de  R que vamos a usar
library("ISLR")
library("SmartEDA")
library("tidyverse")
library(DT) # Para visualizar tablas
library(readr)
library(plyr)
library (MASS)
library(ggpubr) # Para QQ plot
library(ggplot2) # Para graficos
# library(stringr) #Para str_to_title()
# library(reshape) #Para Pivot Tables
# library(VIM) # Para kNN
library(psych) # Para Grafico Correlaciones
library(pastecs) #Para tabla resumen cuantitativa
library(gmodels) #Para tabla resumen cualiativa
library(knitr) #Para Kable
library(kableExtra) #Para Kable
library(hrbrthemes) #Para gráficos densidades
library(dplyr) #Para gráficos densidades
library(vioplot) #Para gráficos violin
library(PASWR) #Estadístico z
library(BSDA) #Estadístico z.test
library(lsr) #Eta2
library(faraway) #Multicolinealidad
library(gridExtra) #Grid graficas
library(corrplot) #Plot para correlaciones
library(ResourceSelection) #Hosmer Lemeshowi
library(InformationValue) #ROC
library(plotROC)#ROC
library(DescTools) #Scheffe test
```

<br><br><br>

******
# **Descripción del dataset**
******


El dataset Titanic reune los datos sobre los pasajeros que viajaban a bordo del Titanic y registra para cada persona su supervivencia o no en el accidente. El Titanic tranportaba a pasajeros con gran diversidad en sus niveles de renta y edad y a bordo se encontraban familias enteras. En el dataset tenemos constancia de la edad y el nivel de renta pensamos que está muy asociado a la clase en la que viajaban las personas.  

Este dataset es importante porque nos permite estudiar cuales son los factores que pueden aumentar la posibilidad de supervivencia de personas que se encuentren en situaciones similares. Estos factores intuimos que peuden ser el estatus social, el sexo, la edad y también tener familiares cerca. Asimismo podemos ver si las pautas marcadas por la sociedad de "mujeres y niños primero" se cumplen cuando las personas se encuentran en situaciones de estres extremo.  

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Carga de los archivos que contienen los datos del train y test
test <- read.csv("titanic/test.csv")
train <- read.csv("titanic/train.csv")

dim(train)
dim(test)
```


```{r echo=TRUE, message=FALSE, warning=FALSE}
# Carga de los archivos que contienen los datos del train y test
test <- read.csv("titanic/test.csv")
train <- read.csv("titanic/train.csv")
outcome <- read.csv("titanic/gender_submission.csv")
dim(train)
dim(test)
dim(outcome)

```

Según los registros, en el Titanic viajaban 2229 personas, de las cuales 913 formaban parte de la tripulación del barco. El dataset que obtenemos de Kaggle tiene un total de 1309 registros, por lo tanto, no todos los pasajeros que viajaban a bordo están incluidos en el dataset.    

El dataset original está compuesto por dos ficheros: el fichero pensado para realizar el entrenamiento de un modelo y el fichero con los datos destinados a testear la calidad del modelo. El fichero de entrenamiento contiene una columna más que el fichero de prueba. Esta columna corresponde a la columna de la clase "Survived".   

El fichero de entrenamiento tiene 891 registros mientras que el el fichero de test contiene 418 líneas.  

Las variables de las que se compone el dataset son:  

**Age**  edad del pasajero     
**Cabin** número de camarote       
**Embarked** indica si el pasajero ha embarcado o no y donde C = Cherbourg, Q = Queenstown, S = Southampton    
**Fare** precio del billete       
**Name**  nombre del pasajero        
**Parch** Indica si el pasajero tenía padres o hijos a bordo        
**PassengerId** identificador del pasajero  
**Pclass** clase en la que viajaba el pasajero  
**Sex** sexo del pasajero    
**SibSp**  indica si el pasajero tenía hermanos o pareja a bordo        
**Survived** indica si el pasajero ha sobrevivido la catástrofe     
**Ticket** número del billete 






```{r echo=TRUE, message=FALSE, warning=FALSE}
# Estructura de los archivos train.csv y test.csv
str(train)
str(test)
```

Aplicamos la función `str` para visualizar las características de los datos de los conjuntos de entrenamiento y test. 

Usamos la función `colnames` para ver los nombres de las columnas en los datos de entrenamiento y test. Además verificamos visualmente que ambos datasets tienen las mismas columnas.  

Las columnas en ambos datasets coniciden, como habría que esperar.  
```{r}
# Column names
sort(colnames(train))
sort(colnames(test))
```


Visualizamos las primeras líneas del conjunto de entrenamiento y de test.  
```{r echo=TRUE, message=FALSE, warning=FALSE}
# Primeras líneas del conjunto de entrenamiento y de test.
head(train)
head(test)
```



******
# **Integración y selección de los datos de interés a analizar.**
******

En este apartado tomaremos las medidas necesarias para integrar los tres conjuntos de datos de los que se compone el dataset en uno solo, con el que trabajaremos. Los conjuntos de datos los hemos guardado como train, test y outcome.  

A continuación seleccionaremos las variables que nos parecen relevantes para nuestro análisis. Recordemos que la intención de este estudio es estudiar las posibilidades de supervivencia en una catástrofe en función de la edad, sexo, clase social, así como si viajar con familiares aumenta la posibilidad de sobrevivir a un desastre.  
  
Por último, crearemos visualizaciones para las distintas variables y sus combinaciones para tener una primera aproximación de los posibles factores que pueden influir en la supervivencia o no de las personas que se encuentran involucradas en un accidente.  

  
## Integración  

Tenemos que unir los datos del dataset test con los datos que corresponden al desenlace de cada pasajero. Antes hemos comprobado que los datos guardados en outcome tienen el mismo número de líneas que los datos del conjunto test. A primera vista parece que los id de los pasajeros se corresponden. Podemos unir los dos datasets con ´merge´ y usando como clave de unión PassengerID.  

Comprobamos que el dataset resultante tiene el tamaño esperado.  

```{r}
test.complete <- merge(outcome, test, by.x="PassengerId")
dim(test.complete)
```

Unimos las filas de los datos de train y los datos de test. Para ello usamos la función ´rbind´

```{r}
df = rbind(train, test.complete)
head(df)
```
Comprobamos las dimensiones del dataset resultante. Verificamos que el número de líneas del dataset resultante es igual a la suma de números de línea de los dos datasets por los que está compuesto.  

```{r}
dim(df)[1] == dim(test.complete)[1] + dim(train)[1]
```

El dataframe que obtenemos como resultado tiene 12 columnas y 1309 filas.  

```{r}
dim(df)
```

Comprobamos si hay líneas duplicadas en el dataframe usando `duplicated`. No existen registros duplicados, pero sí detectamos dos pares de personas con el mismo nombre. Para asegurarnos que se trata de personas diferentes, buscamos los registros que tengan los nombres Connolly, Miss. Kate o Kelly, Mr. James.   

Podría tratarse de la misma persona que ha comprado dos billetes, pero en estos registros vemos que las personas tienen edades diferentes y no hay motivo para pensar que se trata de duplicados.  
```{r}
df[duplicated(df),]

df[duplicated(df[c("Name","Sex")]),]
df[df$Name=="Kelly, Mr. James" | df$Name == "Connolly, Miss. Kate",]

```

## Selección  


En esta sección eliminaremos las variables PassengerId, Ticket y Name porque no son de mucha utilidad para nuestros análisis. Sin embargo, detectammos que han números de billetes duplicados. En esto podemos encontrar una relación entre los pasajeros que no es necesariamente relación familiar. Antes de eliminar la variable ticket vamos a crear una columna con el recuento de billetes con el mismo id para cada pasajero.  

```{r}
library(dplyr)
df$Count.ticket <- (df%>%group_by(Ticket)%>%mutate(count=n()))$count
```




Una vez creada la columna count podemos eliminar algunas de las variables que no consideramos relevantes.  

PassengerId no parece tener mucho poder predictivo ya que se trata de un identificador sin mayor significado. Eliminamos esta columna y sobreescribimos el dataframe.   


Otra variable que vamos a ignorar en los análisis es la del nombre del pasajero. Aunque podría ser interesante para contrastar con el número de familiares (mismo apellido), en esta ocasión no usaremos la variable. Eliminamos la columna que corresponde al nombre del pasajero.  

El número del billete creemos que tampoco es relevante para el análisis. 
```{r}
keep.cols <- c("Survived", "Pclass", "Sex", "Age", "SibSp", "Parch", "Fare", "Cabin", "Embarked", "Count.ticket")
df <- df[keep.cols]

```
**Screening**  

Antes de crear las visualizaciones determinamos que las variables numércias son:  Age y Fare que corresponden a la edad de los pasajeros y el precio del billete. Survived, Sex, Cabin, Embarked son variables categóricas y Pclass, SibSp, Parch son variables categóricas ordinales (existen rangos en los valores de las variables).  

Realizamos las transformaciones oportunas para guardar las variables con sus tipos correspondientes.  

```{r}
# Categóricas
df$Survived <- as.factor(df$Survived)
df$Sex <- as.factor(df$Sex)
df$Cabin <- as.factor(df$Cabin)

# Categóricas ordinales
df$Pclass <- factor(df$Pclass, levels= c(1, 2, 3))
df$SibSp <- factor(df$SibSp, levels = c(0, 1, 2, 3, 4, 5, 8))
df$Parch <- factor(df$Parch, levels = c(0, 1, 2, 3, 4, 5, 6, 9))

```


Creamos una función que nos facilite visualizar las distribuciones de las variables, así como detectar posibles valores extremos.  

```{r }
library(fitdistrplus)
visualiz <- function(data, colm, facet.colm, title, facetPlot=FALSE){
oldpar = par(mfrow = c(2,2), mar=c(2,2,2,2))
truehist(data[[colm]], main = title)
abline(v = mean(data[[colm]]), col="red", lwd=3, lty=2);
abline(v = median(data[[colm]]), lwd=3, lty=2, col="blue");
qqnorm(data[[colm]], main = title);qqline(data[[colm]], col = 2 )
if (facetPlot==TRUE) {
  boxplot(data[[colm]]~data[[facet.colm]], main = paste("Survived by", title))
}

boxplot(data[[colm]], main = title)
}
```


**Visualización de las variables numéricas**  

Los pasajeros que tiennen edades entre los cuantiles 25 y 75 tienen entre 20 y 40 años. La edad mediana para los pasajeros que sobrevivieron y los que no es muy similar.  
```{r}
visualiz(df, "Age", "Survived", "Age", facetPlot=TRUE)
```
Si vemos la variable Fare (precio del billete), la mayoría de los pasajeros pagaron muy poco por el billete. Aquí en el boxplot encontramos outliers pero consideramos que no deberíamos descartar estas entradas ya que hay pocos pasajeros que pagaron un importe alto por el billete y esta información puede ser muy interesante para predecir la posibilidad de supervivencia: ¿Viajar en una clase privilegiada aumenta la posibilidad de sobrevivir?  

En el boxplot además podemos ver que las personas que sobreviven tienen una mediana más alta en el precio del billete. 

```{r}
visualiz(df, "Fare", "Survived", "Fare", facetPlot=TRUE)
```


A continuación visualizamos los datos para las variables Class, Sex, Siblings/Spouse, Parents/Children  



```{r}
oldpar = par(mfrow = c(2,3), mar=c(2,2,2,2))

plot(table(df$Pclass, df$Survived), col = c("black", "orange"), main="Class")

plot(table(df$Sex, df$Survived), col = c("black", "orange"), main="Sex")

plot(table(df$SibSp, df$Survived), col = c("black", "orange"), main="Siblings/Spouse")

plot(table(df$Parch, df$Survived), col = c("black", "orange"), main="Parents/Children")

plot(table(df$Embarked, df$Survived), col = c("black", "orange"), main="Embarked")

plot(table(df$Count.ticket, df$Survived), col = c("black", "orange"), main="Tickets")
```


Las personas que viajaban en tercera clase tienen la menor proporción de supervivencia comparando con las personas que viajaban en primera clase. Las mujeres que viajaban en el titanic sobrevivieron en su mayoría. Los hombres sobrevivieron en mucho menor proporción.   

La mayoría de personas viajaba sin familiares (hermanos, pareja, padres o hijos) y parece ser que el porcentaje de supervivencia es algo más alto en personas que tenían familiares a bordo.   

La mayoría de personas embarcaron en el punto S, pero el mayor porcentaje de supervivencia lo tienen las personas que embarcaron en C.  

Los pasajeros que viajaban varias personas con el mismo billete también tienen una mayor supervivencia ( hasta 4 pasajeros ). 1 o más de 4 pasajeros con el mismo billete tienen la misma proporción de supervivencia.  

**Análisis bivariable**  

Vamos a visualizar algunos plots que nos permiten ver la supervivencia de pasajeros combinando dos variables.  

```{r}
library(grid)
grid.newpage()

sex.class <- ggplot(data=df, aes(x=Sex, fill=Survived))+geom_bar(position = 'fill')+facet_wrap(~Pclass)+ scale_fill_manual(values=c("black", "orange"))
sibs.class <- ggplot(data=df, aes(x=SibSp, fill=Survived))+geom_bar(position = 'fill')+facet_wrap(~Pclass)+ scale_fill_manual(values=c("black", "orange"))
parch.class <- ggplot(data=df, aes(x=Parch, fill=Survived))+geom_bar(position = 'fill')+facet_wrap(~Pclass)+ scale_fill_manual(values=c("black", "orange"))
embark.class <- ggplot(data=df, aes(x=Embarked, fill=Survived))+geom_bar(position = 'fill')+facet_wrap(~Pclass)+ scale_fill_manual(values=c("black", "orange"))

grid.arrange(sex.class, sibs.class, parch.class, embark.class,  ncol=2)

```

Las mujeres que viajaban en primera y segunda clase sobrevivieron casi todas. Los hombres sobrevivieron en mucho menor medida, incluso los hombres que viajaron en primera clase.  

Las personas que viajaban con hermanos o pareja en primera clase sobrevivieron en mayor medida que las personas que viajaron solas. En primera y segunda clase no hay personas que viajasen con más de 3 hermanos. En tercera clase hay personas que viajaron con hasta 8 hermanos en este caso un menor número de hermanos (excepto cero) parece indicar una mayor supervivencia.  

También hemos visualizado la supervivencia en función del lugar donde los pasajeros embarcaron en el Titanic. Los pasajeros de tercera clase que embarcaron en el punto Q han sobrevivido más que los demás, incluso tanto como los pasajeros de segunda clase. En el punto Q embarcaron las personas principalmente de tercera clase, hombres y mujeres en números similares. Posiblemente los pasajeros de tercera clase que embarcaron en este punto tuvieron una ubicación en el Titanic que les permitía tener más fácil acceso a la salida.  


```{r}
ggplot(data=df, aes(x=Sex, fill=Pclass))+geom_bar(position = 'fill')+facet_wrap(~Embarked)+ scale_fill_manual(values=c("black", "orange", "red"))
```

Visualizamos la supervivencia usando las variables de la clase en la que viaja el pasajero y el número de personas que viajan con el mismo billete.  

En el Titanic viajaron familias enteras de hasta 7 personas en primera clase y incluso de 11 personas en tercera clase. La supervivencia de personas que viajaban sobre el mismo billete en tercera clase es coparable con el mismo dato en segunda clase.  

```{r}
ggplot(data=df, aes(x=Count.ticket, fill=Survived))+geom_bar(position = 'fill')+facet_wrap(~Pclass)+ scale_fill_manual(values=c("black", "orange", "red"))
```






```{r}
```


```{r}
```






```{r}
```





******
# **Limpieza de los datos.**  
******

## ¿Los datos contienen ceros o elementos vacíos? ¿Cómo gestionarías cada uno de estos casos?    

Vemos el `summary` para cada una de las variables del dataframe.  

Las variables que contienen NA como tales son Age (263 valores) y Fare (1 valor).  

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Exploración del resumen de los datos de las variables del dataframe 
sapply(df, summary)
```

El número de registros de Age que son NA representan el 20% de los registros totales. Se trata de una proporción demasiado grande para eliminar estos registros. 
```{r }
# Overview of the data - Type = 1
ExpData(data=df,type=1)

# Structure of the data - Type = 2
ExpData(data=df,type=2)

```


Mostramos los datos que contienen valores NA para la variable Age.  
```{r}
head(df[is.na(df$Age),])

```
 Este dataset contiene variables categóricas y numéricas y para imputar los valores podemos usar el método `kNN` del paquete VIM. Aplicamos la función y imputamos los valores NA usando todos los demás campos del dataset. El algoritmo busca los registros de pasajeros más parecidos al que contiene un valor nulo y usa los datos de edades de estos pasajeros para imputar el valor faltante.  

```{r}
library(VIM)
df <- kNN(df, k=3)[1:10]
head(df[is.na(df$Age),])

```

Una vez ejecutado el algoritmo para imputar los valores, volvemos a comprobar si existen valores NA y podemos confirmar que todos los NA para la variable edad han sido imputados. 







Ahora comprobamos las variables que toman valores igual a cero sin que tenga sentido que tomen este tipo de valor.   

La variable que representa la calase toma valores iguales a cero y consideramos que es correcto, lo mismo ocurre con las variables SibSp, Parch, donde consideramos normal que existan valores iguales a cero, significa que los pasajeros viajaban solos.  

En cambio, los valores iguales a cero para la variable Fare son algo más extraños. Entre los pasajeros que tienen un fare igual a cero hay personas que viajaban en primera, segunda y tecera clase. **OLGA: no estoy segura qué hacer aquí.**  
```{r}

df[df$Fare==0,]


```

**Valores extremos** 

No hemos encontrado valores que estén fuera de un rango razonable. Las comprobaciones las hemos hecho anteriormente con `sapply(df, summary)`.  

Volvemos a visualizar boxplots para las variables numéricas que tenemos: Age y Fare.  


```{r}

oldpar = par(mfrow = c(2,2), mar=c(2,2,2,2))

# Boxplot variable Age
boxplot(df$Age, main="Boxplot Variable Age",ylab="Edad (años)")
print("Boxplot Stats Variable Age\n")
boxplot.stats(df$Age, coef = 1.5, do.conf = TRUE, do.out = TRUE)

# Boxplot variable Age
boxplot(df$Fare, main="Boxplot Variable Fare",ylab="Precio billete")
print("Boxplot Stats Variable Fare\n")
boxplot.stats(df$Fare, coef = 1.5, do.conf = TRUE, do.out = TRUE)
```

El boxplot muestra que hay outliers en estas dos variables. La mayoría de los pasajeros eran jóvenes, auqnue también encontramos pasajeros de más de 65 años. En cuanto a la variable Fare, los valores están acotados en un intervalo muy reducido y existen outliers que corresponden a precios de billetes más altos. En este punto tenemos que destacar que la variable Fare parece que no corresponde al precio de un único billete. Si los billetes se compraron juntos, el valor del Fare que encontramos corresponde al precio total de los billetes.  

En la tabla siguiente podemos visualizar los datos de algunos de los pasajeros que pagaron un precio de billete alto. Notamos que hay pasajeros de tercera clase y para estos pasajeros vemos que hay un recuento de billetes mayor que 1 en la mayoría de los casos. Así pues una variable Fare con valor alto puede considerarse como otro indicador de si el pasajero viaja en grupo.  



```{r}
head(df[df$Fare>10,])
```

## Análisis de los datos.  

### Selección de los grupos de datos que se quieren analizar/comparar (planificación de los análisis a aplicar).  

La pregunta que planteamos inicialmente es si entre las variables que tenemos en el dataset existen algunas que influyen en mayor medida en la supervivencia de los pasajeros del Titanic. En los análisis anteriores hemos comprobado visualmente que las personas de primera clase han sobrevivido en mayor medida, que las mujeres y los niños tienen una mayor proporción de supervivencia. También hemos visto que personas que viajan acompañadas, ya sea por familia o amigos, tiene una proporcion de supervivencia algo mejor.   

Vamos a usar estos datos para analizar el dataset en mayor profundidad. Para ello datasets especializados.  


```{r cars}
# Dataframes por clase de pasajero
df.first <- df[df$Pclass==1 ,]
df.second <- df[df$Pclass==2,]
df.first.second <- df[df$Pclass==1 | df$Pclass==2,]
df.first.second$Pclass <- factor(df.first.second$Pclass, levels = c(1,2))
```

```{r}
# Dataframe por sexo del pasajero
df.male <- df[df$Sex=="male", ]
df.female <- df[df$Sex=="female",]
```


```{r}
# Dataframe por edad del pasajero
df.young <- df[df$Age<18,]
df.older <- df[df$Age>=18,]
```


```{r}
# Dataframe por pasajeros que viajaban solos o acompañados
df.single <- df[df$Count.ticket==1,]
df.many <- df[df$Count.ticket>1,]
```

```{r}
df.survived <- df[df$Survived==1,]
df.not.survived <- df[df$Survived==0,]
```


### Comprobación de la normalidad y homogeneidad de la varianza.  

**Normalidad** 
```{r}
visualiz1 <- function(D1, D2, name1, name2, title){
  oldpar = par(mfrow = c(2,2), mar=c(2,2,2,2))
  truehist(D1, main = paste(name1," ", title))
  abline(v = mean(D1), col="red", lwd=3, lty=2);
  abline(v = median(D1), lwd=3, lty=2, col="blue");
  qqnorm(D1, main = paste(name1, " ", title));qqline(D1, col = 2 )
  truehist(D2, main = paste(name2," ", title))
  abline(v = mean(D2), col="red", lwd=3, lty=2);
  abline(v = median(D2), lwd=3, lty=2, col="blue");
  qqnorm(D2, main = paste(name2," ", title)); qqline(D2, col = 2 )
  
}
```



Visualizamos los datos de la edad para personas que sobrevivieron en el hundimiento frente a personas que no sobrevivieron.  

La media y la mediana de los pasajeros que sobrevivieron están muy cerca. Las personas que no sobrevivieron tienen una edad mediana más baja que la edad media. Los valores de estos dos indicadores de tendencia central son más altos para personas que no sobrevivieron: las personas que muerieron tenían una media de edad algo más alta que los que sobrevivieron.  

Según el qqplot las dos distribuciones son cercanas a la normal. Según el teorema del límite central podemos asumir la distribución normal de la media de estas dos muestras ya que sus tamaños son mayores que 30 observaciones.
```{r}
visualiz1(df.survived$Age, df.not.survived$Age, "Survived", "Not Survived", "")
```


Comprobaremos de la igualdad de las varianzas entre los conjuntos de datos de pasajeros que sobrevivieron y no. Para ello usamos la función `var.test`.  

El contraste de varianzas se realiza mediante un contraste de hipótesis, donde aceptar H0 significaría que las varianzas son iguales. 

El valor p-value que obtenemos es de 0.02. Este valor es menor que alfa y indica que con un nivel de confianza del 95% podemos rechazar la hipótesis nula de que las varianzas son iguales. Las varianzas en la edad de los pasajeros que sobrevivieron y los que no sobrevivieron son diferentes.  

```{r}
var.test(df.survived$Age, df.not.survived$Age)
```


**OLGA**: pues ni idea como hacer los test con variables categóricas.  
La mayoría de las variables que consideramos importantes para este estudio contienen datos categóricos. Así es el caso de la clase se los pasajeros, el número de personas con las que viaja y el sexo.  
```{r}
plot(df.young$Survived)
plot(df.older$Survived)
```


```{r}
```


```{r}
```


```{r}
```

### Aplicación de pruebas estadísticas para comparar los grupos de datos. En función de los datos y el objetivo del estudio, aplicar pruebas de contraste de hipótesis, correlaciones, regresiones, etc. Aplicar al menos tres métodos de análisis diferentes.   

** Contraste de hiótesis**  

En las visualizaciones que hemos realizado a lo largo de la actividad hemos visto que las personas que viajaban en primera clase sobrevivieron mucho más que las personas de segunda y tercera clase.  

Planteamos la pregunta de investigación para realizar el contraste de hipótesis: ¿Las personas que viajan en primera clase tienen la misma posibilidad de sobrevivir que las personas que viajan en segunda clase?  

H0: No existe dependencia entre viajar en primera clase y la posibilidad de sobrevivir.  
H1: Existe dependencia entre viajar en primera clase y sobrevivir.  


En primer lugar creamos una tabla de contingencia para ver cuantas personas sobrevivieron según la clase en la que viajaban. Para esto no necesitaremos usar los datos que hemos particionado.    
```{r}

tc<-table( df.first.second$Pclass, df.first.second$Survived )
tc


```

Utilizamos el test Chi cuadrado para comprobar si los pasajeros de primera clase sobrevivieron en mayor medida que los pasajeros de segunda clase.  

El test se aplica en R con un nivel de confianza por defecto del 95%.  
El valor p-value es menor que 0.05, por lo tanto, al rechazar la hipótesis nula no estaríamos cometiendo un error muy grave. Podemos aceptar la hipótesis alternativa H1 y afirmar que sí que existe relación entre la clase en la que viaja el pasajero y su posibilidad de supervivencia, con un nivel de confianza del 95%.  

```{r}
chisq.test(tc, correct=FALSE)
```


**Contraste de hipótesis sobre la edad de supervivencia**

Planteamos la pregunta de investigación: Queremos saber si las personas que sobrevivieron eran más jóvenes que las personas que muerieron en el accidente o, por el contrario, la edad para las personas que muerieron y sobrevivieron es similar.   

Nos encontramos ante el caso en el que podemos asumir la normalidad de las distribuciones de la media de las dos muestras pero sabemos que las varianzas de las muestras son diferentes. Se trata de un test paramétrico de dos muestras.    

H0: La media de edad de las personas supervivientes es la misma que de las personas que muerieron  
H1: La media de edad de las personas que murieron es mayor que la de las personas supervivientes.    

Usamos un test paramétrico definido por `t.test`


Con un valor p-value igual por debajo de 0.05 podemos aceptar la hipótesis H1. Con un nivel de confianza del 95% afirmamos que las personas que murieron en el Titanic tienen una media de edad más alta que las personas que sobrevivieron.  
```{r}
t.test(df.not.survived$Age, df.survived$Age, alternative="greater", var.equal=FALSE)
```

**Regresión**   


Aplicamos una regresión logística para predecir la probabilidad de supervivencia usando como variable predictora la variable sexo.  


```{r}

model0=glm(formula=Survived~Sex, data=df, family=binomial(link=logit))
summary(model0)
```
Calculamos los Odds Ratio que resultan ser todos menores que 1. Esto significa un factor de protección y se interpreta: La probabilidad de ser hombre y sobrevivir (1) es de 3% de la probabilidad de ser mujer y sobrevivir.  


```{r}
exp(coefficients(model0))
```


Aplicamos una regresión logística para comprobar si las variables Sexo y Clase son significativas para la supervivencia en el accidente.  

Ambas variables son significativas y así lo indican los asteriscos junto a los valores Pr(>|z|).  

Ser hombre, viajar en clase 2 o clase 3 reduce la posibilidad de supervivencia con respecto a ser mujer y viajar en primera clase. Esto viene indicado por el signo negativo que acompaña el valor del coeficiente para Sexmale, Pclass2 y Pclass3.   

```{r}

model1=glm(formula=Survived~Sex+Pclass, data=df, family=binomial(link=logit))
summary(model1)
```

Calculamos los odds ratio. Igual que en el caso anterior vemos que la probabilidad ser hombre y sobrevivir es mucho menor que la de ser mujer y sobrevivir. La probabilidad de sobrevivir en segunda clase es 0.43 de la probabilidad de sobrevivir en primera clase. Para la tercera clase la probabilidad de sobrevivir es incluso menor.  
```{r}
exp(coefficients(model1))
```


Por último queremos ver si la probabilidad de sobrevivir es mayor para pasajeros que viajaban acompañados.

En los datos hemos detectado que había hasta 8 pasajeros con el mismo billete. Posiblemente se tratara de familia o amigos. Usaremos esta variable para crear un modelo.  
```{r}


model2=glm(formula=Survived~factor(Count.ticket)+Embarked, data=df, family=binomial(link=logit))
summary(model2)

```

El resultado del modelo indica que cuando dos, tres o cuatro personas viajaban juntas, la probabilidad de sobrevivir aumentaba (signo positivo del coeficiente).  

Calculamos los ORS. Para las personas que viajaban con otra persona, otras dos o tres personas el "riesgo" de sobrevivir es mucho mayor.   

```{r}
exp(coefficients(model2))
```

```{r}
set.seed(1)
df.random <- df[sample(nrow(df)),]
```
```{r}
set.seed(666)
y <- df.random[,1] 
X <- df.random[,-1] 
```


```{r}
indexes = sample(1:nrow(df), size=floor((2/3)*nrow(df)))
trainX<-X[indexes,]
trainy<-y[indexes]
testX<-X[-indexes,]
testy<-y[-indexes]
```


```{r}
# Cargamos la librería
library(rpart.plot)
library(caret)
# Entrenamos el modelo
```


```{r}
treeFit <- rpart(trainy~.,data=trainX,method ='class')
print(treeFit)

```
```{r}
# Árbol resultante.  
rpart.plot(treeFit, box.col=c("red", "green"))
```

```{r}
prediction <- predict(treeFit,newdata=testX,type ='class')
```



```{r}
confusionMatrix(prediction,testy)
```

## Including Plots

