---
title: "**M2.851 – TIPOLOGÍA Y CICLO DE VIDA DE LOS DATOS: PRA 2**"
author: "Olga Garcés Ciemerozum / Carlos Acosta Quintas"
date: 'Junio 2021'
output:
  html_document:
    highlight: default
    number_sections: yes
    theme: cosmo
    toc: yes
    toc_depth: 4

     
---

<style>
body {
text-align: justify}
</style>



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.align="center")
options(width = 500)

```

<br><br><br>


******
# **Carga de librerias**
******

```{r load_libraries, message=FALSE, warning=FALSE, include=FALSE}
# Cargamos las librerias de  R que vamos a usar
library("ISLR")
library("SmartEDA")
library("tidyverse")
library(DT) # Para visualizar tablas
library(readr)
library(plyr)
library (MASS)
library(ggpubr) # Para QQ plot
library(ggplot2) # Para graficos
# library(stringr) #Para str_to_title()
# library(reshape) #Para Pivot Tables
# library(VIM) # Para kNN
library(psych) # Para Grafico Correlaciones
library(pastecs) #Para tabla resumen cuantitativa
library(gmodels) #Para tabla resumen cualiativa
library(knitr) #Para Kable
library(kableExtra) #Para Kable
library(hrbrthemes) #Para gráficos densidades
library(dplyr) #Para gráficos densidades
library(vioplot) #Para gráficos violin
library(PASWR) #Estadístico z
library(BSDA) #Estadístico z.test
library(lsr) #Eta2
library(faraway) #Multicolinealidad
library(gridExtra) #Grid graficas
library(corrplot) #Plot para correlaciones
library(ResourceSelection) #Hosmer Lemeshowi
library(InformationValue) #ROC
library(plotROC)#ROC
library(DescTools) #Scheffe test
```

<br><br><br>


******
# **Descripción del dataset**
******

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Carga del archivo que contiene el dataframe
df <- read.csv("Carseats.csv")
```

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Estructura del archivo que contiene el dataframe
str(df)
```
```{r echo=TRUE, message=FALSE, warning=FALSE}
# Primeras líneas de los datos
head(df)
```

El dataset está compuesto por las variables:  

**Sales** (Ventas unitarias, en miles de dólares, en cada ubicación)   
**CompPrice** (Precio del producto en dólares que cobra el competidor en cada ubicación)   
**Income** (Nivel de ingresos comunitarios, en miles de dólares)   
**Advertising** (Presupuesto de publicidad local de la empresa en cada ubicación, en miles de dólares)   
**Population** (Tamaño de la población en la región, en miles)  
**Price** (Precio del producto en dólares en cada ubicación)   
**ShelveLoc** (Una clasificación clasificando el dato entre Bad, Good y Medium que indica la calidad de la ubicación del producto en los puntos de venta)   
**Age** (Edad media de la población local)   
**Education** (Nivel educativo)   
**Urban** (Una clasificación clasificando el dato entre los niveles Yes y No, que indica si la tienda está en una ubicación rural o urbana)   
**US** (Una clasificación clasificando el dato entre Yes y No para indicar si la tienda se encuentra en USA o no).   

OLGA : INTEGRACIÓN: comprobamos si la base de datos contiene registros duplicados. Para ello usamos la función `duplicated`. Concluimos que no existen registros dupicados en los datos.
```{r}
df[duplicated(df),]
```

Realizamos un análisis general de los datos que nos permite ver el tipo de variable, los valores perdidos por columna y el porcentaje de los mismos sobre el total de valores de la columna. También podemos ver cuántos valores únicos puede tomar cada variable.  

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Sustitución de las variables tipo char por variables categóricas.

df$ShelveLoc <- as.factor(df$ShelveLoc)
df$Urban <- as.factor(df$Urban)
df$US <- as.factor(df$US)
df$Education <- factor(df$Education, levels = c(10, 11, 12, 13, 14, 15, 16, 17, 18))

```


```{r echo=TRUE, message=FALSE, warning=FALSE}
# Exploración del resumen de los datos de las variables del dataframe 
sapply(df, summary)
```


```{r }
# Overview of the data - Type = 1
ExpData(data=df,type=1)

# Structure of the data - Type = 2
ExpData(data=df,type=2)

```

******
# **Integración y selección de los datos**
******


## **Integración de los Datos**


OLGA: Las variables ShelveLoc, Urban, US son variables categóricas. El programa las ha interpretado como character. Corregimos esto aplicando la función `as.factor`y sobreescribimos las variables originales.  

La variable Education también es una variable categórica, en este caso es categórica ordinal ya que existe un órden entre distintos niveles de educación. Guardamos esta variable como factor y le asignamos niveles ordenados.  
```{r echo=TRUE, message=FALSE, warning=FALSE}
# Sustitución de las variables tipo char por variables categóricas.

df$ShelveLoc <- factor(df$ShelveLoc, levels = c("Bad", "Medium", "Good"))
df$Urban <- as.factor(df$Urban)
df$US <- as.factor(df$US)
df$Education <- factor(df$Education, levels = c(10, 11, 12, 13, 14, 15, 16, 17, 18))

```
**OLGA:** si crees que cualquiera de las variables que he puesto no necesita estar en miles, lo puedes cambiar.  
OLGA: Las variables Sales, Income, Advertising, Population vienen representadas en miles de dólares. Multiplicamos todas estas variables por 1000 y sobreescribimos los datos.  

```{r}
vars.miles <- c("Sales", "Income", "Advertising", "Population")
df[vars.miles] <- df[vars.miles] * 1000
```


```{r echo=TRUE, message=FALSE, warning=FALSE}
# Exploración del resumen de los datos de las variables del dataframe 
sapply(df, summary)
```


## **Selección de los Datos**




```{r echo=TRUE, message=FALSE, warning=FALSE, include=TRUE}
# Creación tabla con describe()
col_var_cuantitativa_sin_ID <- c("Sales", "CompPrice", "Income", "Advertising", "Population", "Price", "Age")

df_var_cuantitativa <- df[, col_var_cuantitativa_sin_ID]

df_var_cuantitativa_tabla <- describe(df_var_cuantitativa, quant = TRUE, IQR = TRUE)

# Eliminación campos no usables
df_var_cuantitativa_tabla <- df_var_cuantitativa_tabla[, -c(1, 2, 6, 7, 8, 9, 10, 11, 12, 13, 15)]

# Cambio de nombres de los campos
colnames(df_var_cuantitativa_tabla) <- c("Mean", "St_Dev", "Median","IQR")

# Transpuesta de la matriz
df_var_cuantitativa_tabla <- data.frame(t(df_var_cuantitativa_tabla))
#instadf_var_cuantitativa_tabla
```


```{r echo=TRUE, message=FALSE, warning=FALSE}
# Selección/Filtrado de las instancias que solamente pertenecen a US
# Creación de la tabla mediante kable()

# Formato numérico no científico
options(scipen = 999)

# Variables auxiliares para la creación de la tabla kable() de forma más automática.
# Dimensiones de cada grupo de la tabla
dim_grupo1 = 4


# Límites de las posiciones de los grupos (automatico)
dim1_i <- 1
dim1_f <- dim_grupo1


# Formato de la tabla mediante función kable()
# Formato de los dígitos de los campos
# Creación del título de la tabla y anotación
kable(df_var_cuantitativa_tabla, digits = c(2, 2, 2, 2, 2, 2, 2), caption = "TABLA RESUMEN DE LAS VARIABLES CUANTITATIVAS (Total observaciones: 400)
            __________________________________________________________________________________
      <p>   Sales:         Ventas unitarias, en miles, en cada ubicación
      <p>   CompPrice:     Precio que cobra el competidor en cada ubicación
      <p>   Income:        Nivel de ingresos comunitarios, en miles de dólares
      <p>   Advertising:   Presupuesto de publicidad local de la empresa en cada ubicación, en miles de dólares
      <p>   Population:    Tamaño de la población en la región, en miles
      <p>   Price:         Precio del producto en cada ubicación
      <p>   Age:           Edad media de la población local") %>%
  
  kable_styling("striped",  full_width = T) %>%
  pack_rows("Datos Cuantitativos",
            dim1_i,
            dim1_f,
            label_row_css = "background-color: #666; color: #fff;")
```




Creamos una función par poder visualizar los histogramas de las distintas variables, qqplots y boxplots (de todo el rango o en función de los valores que tome otra variable)

```{r }
library(fitdistrplus)
visualiz <- function(colm, facet.colm, title, facetPlot=FALSE){
oldpar = par(mfrow = c(2,2), mar=c(2,2,2,2))
truehist(df[[colm]], main = title)
abline(v = mean(df[[colm]]), col="red", lwd=3, lty=2);
abline(v = median(df[[colm]]), lwd=3, lty=2, col="blue");
qqnorm(df[[colm]], main = title);qqline(df[[colm]], col = 2 )
if (facetPlot==TRUE) {
  boxplot(df[[colm]]~df[[facet.colm]], main = title)
}

boxplot(df[[colm]], main = title)
}
```


```{r }
visualiz("Sales", "ShelveLoc", "Ventas por Ubicación en estantería")
```


**OLGA:** En lugar de un solo boxplot sugiero varias cosas:  
```{r echo=TRUE, message=FALSE, warning=FALSE}
# Boxplot Advertising
boxplot(df$Advertising)

visualiz("Advertising", "Age", "Publicidad por edad promedio de la población")
```

OLGA: Función para visualizar boxplots agrupados por alguna variable

```{r echo=TRUE, message=FALSE, warning=FALSE}
facet.box <- function(colm, facet){
  boxplot(df[[colm]]~df[[facet]], main = paste(colm, "para distintos niveles de", facet))
}

```

OLGA: Seleccionamos unas columnas que consideramos pueden tener influencia sobre las ventas de sillitas.  
```{r}
cols.facet <- c("Advertising", "Price", "ShelveLoc", "Age", "Education", "Urban", "US")
oldpar = par(mfrow = c(2,2), mar=c(2,2,2,2))
for (colm in cols.facet) {
  
  facet.box("Sales", colm)

  }

```


```{r echo=TRUE, message=FALSE, warning=FALSE}
# Boxplot Advertising
boxplot(df$Advertising)
```


```{r echo=TRUE, message=FALSE, warning=FALSE}
# Selección/Filtrado de las instancias que solamente pertenecen a US
df <- filter(df, US=="Yes")
df
```


Creación de nuevas variables.  

Cremos una variable dicotómica que indica con 1 si la competencia tiene mayor precio unitario y 0 para el caso contrario
```{r echo=TRUE, message=FALSE, warning=FALSE}
df$Higher.price.comp <- ifelse(df$CompPrice >df$Price, 1, 0)
```

Creamos una variable que representa el importe de las ventas en cierto punto de ventas y otra variable que prepresenta el el beneficio (importe de las ventas menos publicidad)

```{r echo=TRUE, message=FALSE, warning=FALSE}
df$SalesValue <- df$Sales*df$Price
df$Profit <- df$Sales*df$Price - df$Advertising*1000
df$Avg.income.person <- df$Income / df$Population
```


```{r echo=TRUE, message=FALSE, warning=FALSE}
facet.box("SalesValue", "Age")
facet.box("SalesValue", "Education")
facet.box("SalesValue", "Urban")
facet.box("SalesValue", "ShelveLoc")
facet.box("Sales", "ShelveLoc")
facet.box("Sales", "Age")

facet.box("Profit", "Age")
facet.box("Profit", "Education")
facet.box("Profit", "ShelveLoc")
facet.box("Profit", "Urban")
facet.box("Profit", "Higher.price.comp")

facet.box("SalesValue", "Advertising")
facet.box("Sales", "Advertising")
```
OLGA: El beneficio es casi siempre negativo. Podemos filtrar por los valores de beneficio negativos para ver si tienen alguna característica en otras cosas
```{r echo=TRUE, message=FALSE, warning=FALSE}
visualiz("Profit", "ShelveLoc", "Profit", facetPlot=TRUE)
```



```{r echo=TRUE, message=FALSE, warning=FALSE}

```

```{r echo=TRUE, message=FALSE, warning=FALSE}

```

```{r echo=TRUE, message=FALSE, warning=FALSE}

```

```{r echo=TRUE, message=FALSE, warning=FALSE}

```

```{r echo=TRUE, message=FALSE, warning=FALSE}

```


******
# **Limpieza de datos**
******

## **Datos con ceros o vacíos**

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Comprobacion registros nulos.
sum(is.na(df))
```


Para cada columna visualizamos los valores únicos y ordenados de menor a mayor. La variable Advertising tiene valores iguales a cero. No existen valores cero ni NA en ninguna otra columna. 

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Comprobacion registros iguales a cero.
sapply(sapply(df, unique), sort)
# IMPLEMENTAR FUNCION
```



```{r echo=TRUE, message=FALSE, warning=FALSE}
# Comprobacion registros iguales a cero.

# IMPLEMENTAR FUNCION
```

## **Datos con valores extremos**



```{r , fig.height=4, fig.width=6}
# Boxplot variable Sales
boxplot(df$Sales, main="Boxplot Variable Sales",ylab="Dólares")
boxplot.stats(df$Sales, coef = 1.5, do.conf = TRUE, do.out = TRUE)
```
OLGA: hola Carlos. Me parece que hacer los boxplots cada uno en su caja es muy grande y largo de hacer scroll down. Te propongo una alternativa con los boxplots juntos en una rejilla. Creo que se ve lo bastante bien. Aparte imprime las estadísticas del boxplot.  

CARLOS: Hi, todo lo que sea mejorar aspecto o presentación, por mi sin problema, puedes borrar y ponerlo todo como veas mejor, no te preocupes si borrar mi código, lo tengo todo en copia de seguridad.... puedes modificar lo que quieras!

```{r, fig.height=4, fig.width=8}

oldpar = par(mfrow = c(2,3), mar=c(2,2,2,2))
# Boxplot variable CompPrice
boxplot(df$CompPrice, main="Boxplot Variable CompPrice",ylab="Dólares")
print("Boxplot Stats CompPrice\n")
boxplot.stats(df$CompPrice, coef = 1.5, do.conf = TRUE, do.out = TRUE)

# Boxplot variable Income
boxplot(df$Income, main="Boxplot Variable Income",ylab="Dólares")
print("Boxplot Stats Variable Income\n")
boxplot.stats(df$Income, coef = 1.5, do.conf = TRUE, do.out = TRUE)

# Boxplot variable Advertising
boxplot(df$Advertising, main="Boxplot Variable Advertising",ylab="Dólares")
print("Boxplot Stats Variable Advertising\n")
boxplot.stats(df$Advertising, coef = 1.5, do.conf = TRUE, do.out = TRUE)

# Boxplot variable Population
boxplot(df$Population, main="Boxplot Variable Population",ylab="Personas (miles)")
print("Boxplot Stats Variable Population\n")
boxplot.stats(df$Population, coef = 1.5, do.conf = TRUE, do.out = TRUE)

# Boxplot variable Price
boxplot(df$Price, main="Boxplot Variable Price",ylab="Dólares")
print("Boxplot Stats Variable Price\n")
boxplot.stats(df$Price, coef = 1.5, do.conf = TRUE, do.out = TRUE)

# Boxplot variable Age
boxplot(df$Age, main="Boxplot Variable Age",ylab="Edad (años)")
print("Boxplot Stats Variable Age\n")
boxplot.stats(df$Age, coef = 1.5, do.conf = TRUE, do.out = TRUE)
```











```{r}
library(ggplot2)
scatter.viz <- function(x, y, tag.col, color.col) {
  ggplot(data=df,  aes(x = x, y = y,  label = tag.col)) + 
  geom_point() + 
  #scale_colour_manual(values = c("blue", "green", "yellow", "red")) +
  geom_text(aes(color = color.col), hjust=1.1, vjust=1.1, size = 5) +
  labs(title = "Google", x = "Correlation Coefficient", y = "Top-Box %")
  
}

```


```{r}
scatter.viz(df$CompPrice, df$Price, df$Urban, df$Education)
```

```{r}
scatter.viz(df$ShelveLoc, df$Advertising, df$Urban, df$Age)
```


```{r}
scatter.viz(df$CompPrice, df$Price, df$Urban, df$Education)
```


```{r}
scatter.viz(df$CompPrice, df$Price, df$Urban, df$Education)
```


```{r}
scatter.viz(df$CompPrice, df$Price, df$Urban, df$Education)
```




******
# **Análisis de datos**
******



******
# **Representación de resultados**
******



******
# **Resolución del problema**
******


******
# **Creación del archivo preprocesado**
******

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Guardamos el archivo con el nombre Carseats_processed.csv
write.csv(df, "Carseats_processed.csv", row.names = FALSE)
```


<br>


